<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="黄佳荣" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Django ORM, Django, " />

<meta property="og:title" content="Django ORM练习以及相应的Sql "/>
<meta property="og:url" content="/blog/2019_11_08/django-orm-practice" />
<meta property="og:description" content="练习Django的ORM, 以及给出相应的sql语句加深对ORM的理解" />
<meta property="og:site_name" content="黄佳荣的博客" />
<meta property="og:article:author" content="黄佳荣" />
<meta property="og:article:published_time" content="2019-11-08T00:00:00+08:00" />
<meta property="og:article:modified_time" content="2019-11-08T00:00:00+08:00" />
<meta name="twitter:title" content="Django ORM练习以及相应的Sql ">
<meta name="twitter:description" content="练习Django的ORM, 以及给出相应的sql语句加深对ORM的理解">

        <title>Django ORM练习以及相应的Sql  · 黄佳荣的博客
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/admonition.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>黄佳荣的博客</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories">Categories</a></li>
                                <li ><a href="/tags">Tags</a></li>
                                <li ><a href="/archives">Archives</a></li>
                                <li><form class="navbar-search" action="/search" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/blog/2019_11_08/django-orm-practice">
                Django ORM练习以及相应的Sql
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#_1">前言</a></li>
<li><a href="#_2">练习所需数据库表</a></li>
<li><a href="#_3">初始化数据</a></li>
<li><a href="#_4">题目</a><ul>
<li><a href="#1-12">1. 查询1编号课程比编号2课程成绩高的学生的信息及课程分数</a></li>
<li><a href="#2-60">2. 查询平均成绩大于等于60分的同学的学生编号和学生姓名和平均成绩</a></li>
<li><a href="#3">3. 查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩</a></li>
<li><a href="#4">4. 查询"李"姓老师的数量</a></li>
<li><a href="#5">5. 查询学过"张三"老师授课的同学的信息</a></li>
<li><a href="#6">6. 查询没学过"张三"老师授课的同学的信息</a></li>
</ul>
</li>
<li><a href="#_5">未完待续</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<h3 id="_1">前言</h3>
<p>练习Django的ORM, 以及给出相应的sql语句加深对Django ORM的理解. 题目来自网上的Mysql练习, 自己用ORM实现.</p>
<p>使用Django的debug_tools第三方库显示相应的sql语句.相应的sql我会进行显示的优化.</p>
<p>环境: Django2.2, MySql5.7</p>
<hr/>
<h3 id="_2">练习所需数据库表</h3>
<ol>
<li>学生表 Student(id, Sname, Sage, Ssex), 字段分别为学生编号, 姓名, 出生年月和性别.</li>
<li>教师表 Teacher(id, Tname), 字段分别为教师编号和教师姓名.</li>
<li>课程表 Course(id, Cname, teacher_id), 字段分别为课程编号, 课程名和教师编号.</li>
<li>成绩表 SC(id, student_id, course_id, score), 字段分别为成绩表编号, 学生id, 课程id, 分数.</li>
</ol>
<p>models.py文件如下:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">Student</span>(<span class="n">models</span>.<span class="n">Model</span>):
    <span class="n">Sname</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">verbose_name</span>=<span class="s">'学生姓名'</span>, <span class="n">max_length</span>=<span class="mi">255</span>)
    <span class="n">Sage</span> = <span class="n">models</span>.<span class="n">DateField</span>(<span class="n">verbose_name</span>=<span class="s">'出生年月'</span>)
    <span class="n">Ssex</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">verbose_name</span>=<span class="s">'性别'</span>, <span class="n">max_length</span>=<span class="mi">2</span>)

<span class="k">class</span> <span class="n">Teacher</span>(<span class="n">models</span>.<span class="n">Model</span>):
    <span class="n">Tname</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">verbose_name</span>=<span class="s">'教师姓名'</span>, <span class="n">max_length</span>=<span class="mi">255</span>)

<span class="k">class</span> <span class="n">Course</span>(<span class="n">models</span>.<span class="n">Model</span>):
    <span class="n">Cname</span> = <span class="n">models</span>.<span class="n">CharField</span>(<span class="n">verbose_name</span>=<span class="s">'课程名'</span>, <span class="n">max_length</span>=<span class="mi">255</span>)
    <span class="n">teacher</span> = <span class="n">models</span>.<span class="n">ForeignKey</span>(<span class="n">Teacher</span>, <span class="n">verbose_name</span>=<span class="s">'授课教师'</span>, <span class="n">on_delete</span>=<span class="n">models</span>.<span class="n">CASCADE</span>)
    <span class="n">student</span> = <span class="n">models</span>.<span class="n">ManyToManyField</span>(<span class="n">Student</span>, <span class="n">through</span>=<span class="s">'SC'</span>)

<span class="k">class</span> <span class="n">SC</span>(<span class="n">models</span>.<span class="n">Model</span>):
    <span class="n">student</span> = <span class="n">models</span>.<span class="n">ForeignKey</span>(<span class="n">Student</span>, <span class="n">verbose_name</span>=<span class="s">'学生'</span>, <span class="n">on_delete</span>=<span class="n">models</span>.<span class="n">CASCADE</span>, <span class="n">related_name</span>=<span class="s">'sc_student'</span>)
    <span class="n">course</span> = <span class="n">models</span>.<span class="n">ForeignKey</span>(<span class="n">Course</span>, <span class="n">verbose_name</span>=<span class="s">'课程'</span>, <span class="n">on_delete</span>=<span class="n">models</span>.<span class="n">CASCADE</span>)
    <span class="n">score</span> = <span class="n">models</span>.<span class="n">IntegerField</span>(<span class="n">verbose_name</span>=<span class="s">'分数'</span>)
</pre></div>
<hr/>
<h3 id="_3">初始化数据</h3>
<p>新建init_data.py文件以便添加初始数据:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1">#获取当前文件的路径</span>
<span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="c1">#获取项目的根目录</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pwd</span><span class="o">+</span><span class="s1">'../../'</span><span class="p">)</span>
<span class="c1">#加根目录加入路径后才可得到我项目中的setting文件, 请根据自己的情况修改</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"DJANGO_SETTINGS_MODULE"</span><span class="p">,</span> <span class="s2">"config.settings.local"</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">django</span>
<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">zanhu.demo.models</span> <span class="kn">import</span> <span class="n">Teacher</span><span class="p">,</span> <span class="n">Student</span><span class="p">,</span> <span class="n">Course</span><span class="p">,</span> <span class="n">SC</span>

<span class="n">student_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'赵雷'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1990-01-01'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'男'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'钱电'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1990-12-21'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'男'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'孙风'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1990-05-20'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'男'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'李云'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1990-08-06'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'男'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'周梅'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1991-12-01'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'女'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'吴兰'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1992-03-01'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'女'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'郑竹'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1989-07-01'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'女'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">'Sname'</span><span class="p">:</span> <span class="s1">'王菊'</span><span class="p">,</span> <span class="s1">'Sage'</span><span class="p">:</span> <span class="s1">'1990-01-20'</span><span class="p">,</span> <span class="s1">'Ssex'</span><span class="p">:</span> <span class="s1">'女'</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">teacher_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'Tname'</span><span class="p">:</span> <span class="s1">'张三'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'Tname'</span><span class="p">:</span> <span class="s1">'李四'</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'Tname'</span><span class="p">:</span> <span class="s1">'王五'</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">course_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'Cname'</span><span class="p">:</span> <span class="s1">'语文'</span><span class="p">,</span> <span class="s1">'teacher_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'Cname'</span><span class="p">:</span> <span class="s1">'数学'</span><span class="p">,</span> <span class="s1">'teacher_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'Cname'</span><span class="p">:</span> <span class="s1">'英语'</span><span class="p">,</span> <span class="s1">'teacher_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">sc_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">90</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">99</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">70</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">76</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">87</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">31</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">34</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">89</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'student_id'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'course_id'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'score'</span><span class="p">:</span> <span class="mi">98</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">([</span><span class="n">Student</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">student_data</span><span class="p">])</span>
<span class="n">Teacher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">([</span><span class="n">Teacher</span><span class="p">(</span><span class="o">**</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">teacher_data</span><span class="p">])</span>
<span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">([</span><span class="n">Course</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">course_data</span><span class="p">])</span>
<span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">([</span><span class="n">SC</span><span class="p">(</span><span class="o">**</span><span class="n">sc</span><span class="p">)</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sc_data</span><span class="p">])</span>
</pre></div>
<hr/>
<h3 id="_4">题目</h3>
<h4 id="1-12">1. 查询1编号课程比编号2课程成绩高的学生的信息及课程分数</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># 我的思路是将SC表里id为1的课程和id为2的课程通过连接, 然后比较. </span>
<span class="c1"># 但是Django的ORM我找不到自表相连的方法, 所以是执行sql语句获得.</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s1">'''(SELECT id, score1, score2, sc1.student_id, Sname, Ssex, Sage</span>
<span class="s1">FROM</span>
<span class="s1">    (SELECT score score1, student_id, Sname, Ssex, Sage</span>
<span class="s1">    FROM demo_sc INNER JOIN demo_student ON demo_student.id=student_id</span>
<span class="s1">    WHERE course_id=1) sc1</span>
<span class="s1">    INNER JOIN</span>
<span class="s1">    (SELECT score score2, student_id, id</span>
<span class="s1">    FROM demo_sc</span>
<span class="s1">    WHERE course_id=2) sc2</span>
<span class="s1">    ON sc1.student_id = sc2.student_id</span>
<span class="s1">WHERE sc1.score1 &gt; sc2.score2</span>
<span class="s1">)'''</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Sname</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">Sage</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">Ssex</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">score1</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<hr/>
<h4 id="2-60">2. 查询平均成绩大于等于60分的同学的学生编号和学生姓名和平均成绩</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">'student'</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'student_id'</span><span class="p">,</span><span class="s1">'student__Sname'</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">avg_score</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">'score'</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">avg_score__gte</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">'student_id'</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">'student__Sname'</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">'avg_score'</span><span class="p">])</span>
</pre></div>
</td></tr></table>
<p>对应的sql:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span><span class="p">,</span>
       <span class="k">AVG</span><span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">score</span><span class="p">)</span> <span class="k">AS</span> <span class="n">avg_score</span>
  <span class="k">FROM</span> <span class="n">SC</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Student</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span>
<span class="k">HAVING</span> <span class="k">AVG</span><span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">score</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">60</span>
</pre></div>
</td></tr></table>
<hr/>
<h4 id="3">3. 查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">'student'</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'student_id'</span><span class="p">,</span> <span class="s1">'student__Sname'</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">course_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">'course_id'</span><span class="p">),</span><span class="n">all_score</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">'score'</span><span class="p">))</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>对应的sql:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span><span class="p">,</span>
       <span class="k">COUNT</span><span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">course_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">course_cnt</span><span class="p">,</span>
       <span class="k">SUM</span><span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">score</span><span class="p">)</span> <span class="k">AS</span> <span class="n">all_score</span>
  <span class="k">FROM</span> <span class="n">SC</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Student</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span>
</pre></div>
</td></tr></table>
<hr/>
<h4 id="4">4. 查询"李"姓老师的数量</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">cnt</span> <span class="o">=</span> <span class="n">Teacher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Tname__istartswith</span><span class="o">=</span><span class="s1">'李'</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>对应的sql:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">__count</span>
  <span class="k">FROM</span> <span class="n">Teacher</span>
 <span class="k">WHERE</span> <span class="n">Teacher</span><span class="p">.</span><span class="n">Tname</span> <span class="k">LIKE</span> <span class="s1">'李%'</span>
</pre></div>
</td></tr></table>
<hr/>
<h4 id="5">5. 查询学过"张三"老师授课的同学的信息</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">'student'</span><span class="p">,</span> <span class="s1">'course__teacher'</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">course__teacher__Tname__iexact</span><span class="o">=</span><span class="s1">'张三'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">Sname</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">student</span><span class="o">.</span><span class="n">Sage</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>对应的sql:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">SC</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span>
       <span class="n">SC</span><span class="p">.</span><span class="n">course_id</span><span class="p">,</span>
       <span class="n">SC</span><span class="p">.</span><span class="n">score</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sage</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Ssex</span><span class="p">,</span>
       <span class="n">Course</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="n">Course</span><span class="p">.</span><span class="n">Cname</span><span class="p">,</span>
       <span class="n">Course</span><span class="p">.</span><span class="n">teacher_id</span><span class="p">,</span>
       <span class="n">Teacher</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="n">Teacher</span><span class="p">.</span><span class="n">Tname</span>
  <span class="k">FROM</span> <span class="n">SC</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Course</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">course_id</span> <span class="o">=</span> <span class="n">Course</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Teacher</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">Course</span><span class="p">.</span><span class="n">teacher_id</span> <span class="o">=</span> <span class="n">Teacher</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Student</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">WHERE</span> <span class="n">Teacher</span><span class="p">.</span><span class="n">Tname</span> <span class="k">LIKE</span> <span class="s1">'张三'</span>
</pre></div>
</td></tr></table>
<hr/>
<h4 id="6">6. 查询没学过"张三"老师授课的同学的信息</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">#我的思路是先找出上一题的答案, 将学过"张三"老师授课的同学的id放到列表里,</span>
<span class="c1">#再从Student表中过滤</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">SC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">'course__teacher'</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">course__teacher__Tname__iexact</span><span class="o">=</span><span class="s1">'张三'</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">'student'</span><span class="p">)</span>

<span class="n">student_id</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span><span class="p">[</span><span class="s1">'student'</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>对应的sql有两条:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">SC</span><span class="p">.</span><span class="n">student_id</span>
  <span class="k">FROM</span> <span class="n">SC</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Course</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">SC</span><span class="p">.</span><span class="n">course_id</span> <span class="o">=</span> <span class="n">Course</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Teacher</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">Course</span><span class="p">.</span><span class="n">teacher_id</span> <span class="o">=</span> <span class="n">Teacher</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
 <span class="k">WHERE</span> <span class="n">Teacher</span><span class="p">.</span><span class="n">Tname</span> <span class="k">LIKE</span> <span class="s1">'张三'</span>

<span class="k">SELECT</span> <span class="n">Student</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sname</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Sage</span><span class="p">,</span>
       <span class="n">Student</span><span class="p">.</span><span class="n">Ssex</span>
  <span class="k">FROM</span> <span class="n">Student</span>
 <span class="k">WHERE</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">Student</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
</pre></div>
</td></tr></table>
<hr/>
<h2 id="_5">未完待续</h2>


            
            
            






<section>
    <h6 style="display:none;">Comments</h6>
    <p id="comment-message"> </p>

    <div class="accordion" id="accordion2">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle disqus-comment-count comment-count"
                   data-toggle="collapse"
                   data-parent="#accordion2"
                   href="/blog/2019_11_08/django-orm-practice#comment_thread"
                   id="comment-accordion-toggle">
                    Comments
                </a>
            </div>
            <div id="comment_thread" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div class="comments">

                        <script src="https://utteranc.es/client.js"
        data-repo="huangjiarong/huangjiarong.github.io"
        data-issue-term="/blog/2019_11_08/django-orm-practice"
        data-label=""
        data-theme=""
        crossorigin="anonymous"
        async>
</script>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="/blog/2019_11_07/supervisor-and-django" title="Previous: 使用Supervisor管理Django进程">使用Supervisor管理Django进程</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2019-11-08T00:00:00+08:00">11月 8, 2019</time>

            <h4>Category</h4>
            <a class="category-link" href="/categories#django-ref">Django</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags#django-orm-ref">Django ORM
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </div>
        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        <a href="http://www.beian.miit.gov.cn">粤ICP备19124005号</a>
        <a href="http://www.beian.miit.gov.cn">粤ICP备19124005号-1</a>
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>