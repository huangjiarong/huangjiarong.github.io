<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="黄佳荣" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="源码解读, Django, " />

<meta property="og:title" content="Django源码解读之ListView "/>
<meta property="og:url" content="/blog/2019_09_23/listview-source.html" />
<meta property="og:description" content="对Django的ListView源码解读" />
<meta property="og:site_name" content="黄佳荣的博客" />
<meta property="og:article:author" content="黄佳荣" />
<meta property="og:article:published_time" content="2019-09-23T00:00:00+08:00" />
<meta property="og:article:modified_time" content="2019-09-23T00:00:00+08:00" />
<meta name="twitter:title" content="Django源码解读之ListView ">
<meta name="twitter:description" content="对Django的ListView源码解读">

        <title>Django源码解读之ListView  · 黄佳荣的博客
</title>
        <!-- <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet"> -->
        <link href="/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="/theme/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/admonition.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>黄佳荣的博客</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories">Categories</a></li>
                                <li ><a href="/tags">Tags</a></li>
                                <li ><a href="/archives">Archives</a></li>
                                <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/blog/2019_09_23/listview-source.html"> Django源码解读之ListView  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#1-listviewmro">1. ListView的方法解析顺序(MRO)和属性</a></li>
<li><a href="#2">2. 从路由解析说起</a></li>
<li><a href="#3-listviewget">3. ListView中的get方法</a><ul>
<li><a href="#31-get_queryset">3.1 get_queryset获取数据库数据</a></li>
<li><a href="#32-allow_empty">3.2 allow_empty</a></li>
<li><a href="#33-get_context_data">3.3 get_context_data()获取上下文</a></li>
<li><a href="#34-render_to_response">3.4 render_to_response渲染到前端</a></li>
</ul>
</li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<p>本文以从url解析到数据渲染到前端这个流程来对Django的ListView源码进行解读, 通过本文可以更深入理解ListView中各个属性的用法.
</p>
<p>环境: Django2.2版本</p>
<h2 id="1-listviewmro">1. ListView的方法解析顺序(MRO)和属性</h2>
<p>MRO:</p>
<ol>
<li>ListView</li>
<li>MultipleObjectTemplateResponseMixin </li>
<li>TemplateResponseMixin </li>
<li>BaseViewList</li>
<li>MultipleObjectMixin </li>
<li>ContextMixin </li>
<li>View</li>
</ol>
<p>属性:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">allow_empty</span> <span class="o">=</span> <span class="k">True</span>
<span class="n">content_type</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">context_object_name</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">extra_context</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'get'</span><span class="p">,</span> <span class="s1">'post'</span><span class="p">,</span> <span class="s1">'put'</span><span class="p">,</span> <span class="s1">'patch'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="s1">'head'</span><span class="p">,</span> <span class="s1">'options'</span><span class="p">,</span> <span class="s1">'trace'</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">page_kwarg</span> <span class="o">=</span> <span class="s1">'page'</span>
<span class="n">paginate_by</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">paginate_orphans</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">paginator_class</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">class</span> <span class="s1">'django.core.paginator.Paginator'</span><span class="o">&gt;</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">response_class</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">class</span> <span class="s1">'django.template.response.TemplateResonse'</span><span class="o">&gt;</span>
<span class="n">template_engine</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">template_name</span> <span class="o">=</span> <span class="k">None</span>
<span class="n">template_name_suffix</span> <span class="o">=</span> <span class="s1">'_list'</span>
</pre></div>
</td></tr></table>
<hr/>
<h2 id="2">2. 从路由解析说起</h2>
<div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="n">r</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">IndexListView</span><span class="p">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'index'</span><span class="p">),</span>
    <span class="o">#</span><span class="n">path</span><span class="p">(</span><span class="n">r</span><span class="s1">''</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="k">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'index'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<p>path第二个参数为函数, 我们写函数视图时直接传函数视图, 为什么写类视图就要写as_view()呢? as_view在父类View中, 下面是as_view的源码:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@classonlymethod</span>
<span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">initkwargs</span><span class="p">):</span>
    <span class="sd">"""Main entry point for a request-response process."""</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">initkwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">http_method_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"You tried to pass in the </span><span class="si">%s</span><span class="s2"> method name as a "</span>
                            <span class="s2">"keyword argument to </span><span class="si">%s</span><span class="s2">(). Don't do that."</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">() received an invalid keyword </span><span class="si">%r</span><span class="s2">. as_view "</span>
                            <span class="s2">"only accepts arguments that are already "</span>
                            <span class="s2">"attributes of the class."</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">initkwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'head'</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'request'</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">"</span><span class="si">%s</span><span class="s2"> instance has no 'request' attribute. Did you override "</span>
                <span class="s2">"setup() and forget to call super()?"</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">view_class</span> <span class="o">=</span> <span class="bp">cls</span>
    <span class="n">view</span><span class="o">.</span><span class="n">view_initkwargs</span> <span class="o">=</span> <span class="n">initkwargs</span>

    <span class="c1"># take name and docstring from class</span>
    <span class="n">update_wrapper</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="p">())</span>

    <span class="c1"># and possible attributes set by decorators</span>
    <span class="c1"># like csrf_exempt from dispatch</span>
    <span class="n">update_wrapper</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span> <span class="n">assigned</span><span class="o">=</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">view</span>
</pre></div>
</td></tr></table>
<p>这里<code>classonlymethod</code>装饰器限制了as_view方法只能通过类调用, 源码大致可以分为两部分, 第一部分对请求进行判断, 第二部分定义了<code>view</code>方法并对该方法进行了一些处理后返回该方法, 所以<code>as_view</code>是个闭包, 只能通过类调用, <code>IndexListView.as_view()</code>也就是调用了as_view中的view方法.
</p>
<p>所以重点在view方法, view先创建了个类的实例, 通过<code>self.setup(request, *args, **kwargs)</code>将request和其他参数设置到实例中, 最后调用<code>dispatch</code>方法并返回, dispatch源码:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Try to dispatch to the right method; if a method doesn't exist,</span>
    <span class="c1"># defer to the error handler. Also defer to the error handler if the</span>
    <span class="c1"># request method isn't on the approved list.</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_names</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p><code>dispatch</code>对请求进行分发, 最终调用相应的请求方法并返回, 比如用GET请求, <code>handler = get</code>然后调用<code>handler(request, *args, **kwargs)</code>也就是<code>get(request, *args, **kwargs)</code>.</p>
<hr/>
<h2 id="3-listviewget">3. ListView中的get方法</h2>
<p>父类BaseListView中实现了get方法, 下面是源码:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
    <span class="n">allow_empty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allow_empty</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_empty</span><span class="p">:</span>
        <span class="c1"># When pagination is enabled and object_list is a queryset,</span>
        <span class="c1"># it's better to do a cheap query than to load the unpaginated</span>
        <span class="c1"># queryset in memory.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginate_by</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_list</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_list</span><span class="p">,</span> <span class="s1">'exists'</span><span class="p">):</span>
            <span class="n">is_empty</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_empty</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span>
        <span class="k">if</span> <span class="n">is_empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">"Empty list and '</span><span class="si">%(class_name)s</span><span class="s2">.allow_empty' is False."</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">'class_name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">})</span>
    <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<h3 id="31-get_queryset">3.1 get_queryset获取数据库数据</h3>
<p>get方法中先调用了<code>get_queryset()</code>, 该方法在父类MultipleObjectMixin中:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return the list of items for this view.</span>
<span class="sd">    The return value must be an iterable and may be an instance of</span>
<span class="sd">    `QuerySet` in which case `QuerySet` specific behavior will be enabled.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">):</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
            <span class="s2">"</span><span class="si">%(cls)s</span><span class="s2"> is missing a QuerySet. Define "</span>
            <span class="s2">"</span><span class="si">%(cls)s</span><span class="s2">.model, </span><span class="si">%(cls)s</span><span class="s2">.queryset, or override "</span>
            <span class="s2">"</span><span class="si">%(cls)s</span><span class="s2">.get_queryset()."</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">'cls'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ordering</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ordering</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="n">ordering</span><span class="p">,)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">ordering</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">queryset</span>
</pre></div>
</td></tr></table>
<p>该方法需要在视图中定义了queryset属性或者model属性, 默认的queryset和model属性都为None.如果定义了queryset那么返回的就是写的queryset, 否则返回的是<code>model名.objects.all()</code>. 所以如果要修改获取的数据的话那么可以重写该方法.
</p>
<code>get_ordering()</code>排序方法返回了实例的ordering属性, 默认为None, ordering可以是str或者元组, 从代码可以看出如果是str那么这里将会转化为元祖, 然后将queryset排序后返回.

<h3 id="32-allow_empty">3.2 allow_empty</h3>
<p><code>get_allow_empty()</code>返回实例的allow_empty属性, 默认为None. allow_empty=True时允许返回objects_list为空的列表, allow_empty为None或False时返回Http404, 从代码可以看出.
</p>
<h3 id="33-get_context_data">3.3 get_context_data()获取上下文</h3>
<p>父类MultipleObjectMixin和ContextMixin都定义了该方法, 按照ListView的Mro先找到父类MultipleObjectMixin中的方法, 代码如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">object_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""Get the context for this view."""</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">object_list</span> <span class="k">if</span> <span class="n">object_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginate_by</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_object_name</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">page_size</span><span class="p">:</span>
        <span class="n">paginator</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">is_paginated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'paginator'</span><span class="p">:</span> <span class="n">paginator</span><span class="p">,</span>
            <span class="s1">'page_obj'</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="s1">'is_paginated'</span><span class="p">:</span> <span class="n">is_paginated</span><span class="p">,</span>
            <span class="s1">'object_list'</span><span class="p">:</span> <span class="n">queryset</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'paginator'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">'page_obj'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">'is_paginated'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s1">'object_list'</span><span class="p">:</span> <span class="n">queryset</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">context_object_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="n">context_object_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">queryset</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>queryset为传入的object_list参数或者实例的object_list, 也就是前面<code>get_queryset()</code>获取的数据.</p>
<p><code>get_paginate_by(queryset)</code>方法返回了实例的paginate_by属性, 默认为None, 该属性定义了分页每页的大小.</p>
<p>context_object_name是用于前端对后端获取的queryset的命名, 用模板语言的就是{{ news_list }}这样. 实例context_object_name属性默认为None, <code>get_context_object_name()</code>方法返回自定义的context_object_name或者<code>model名s_list</code>.下面是代码:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_context_object_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
    <span class="sd">"""Get the name of the item to be used in the context."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_object_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_object_name</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">_list'</span> <span class="o">%</span> <span class="n">object_list</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</td></tr></table>
<p>回到get_context_data方法, 如果定义了分页属性paginate_by, 那么将调用<code>paginate_queryset(queryset, page_size)</code>对queryset进行分页, 下面是代码:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">paginate_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">):</span>
    <span class="sd">"""Paginate the queryset, if needed."""</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span>
        <span class="n">queryset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">,</span> <span class="n">orphans</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_paginate_orphans</span><span class="p">(),</span>
        <span class="n">allow_empty_first_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_allow_empty</span><span class="p">())</span>
    <span class="n">page_kwarg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_kwarg</span>
    <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page_kwarg</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page_kwarg</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">page_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">==</span> <span class="s1">'last'</span><span class="p">:</span>
            <span class="n">page_number</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">num_pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">"Page is not 'last', nor can it be converted to an int."</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">paginator</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">object_list</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">has_other_pages</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">InvalidPage</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">'Invalid page (</span><span class="si">%(page_number)s</span><span class="s1">): </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">'page_number'</span><span class="p">:</span> <span class="n">page_number</span><span class="p">,</span>
            <span class="s1">'message'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">})</span>
</pre></div>
</td></tr></table>
<p><code>get_paginator</code>使用实例的paginator_class类创建一个Paginator实例对象, 默认的paginator_class是Django自带的Paginator, 如对Django的分页不了解请查询相关文档.</p>
<p>page_kwarg参数默认为'page', 该参数是对前端传过来的页数的命名, 第7行获取接受的页码数, 也就是请求的第几页.然后从15行开始从分页对象paginator获取相关页的数据, 然后以元祖的形式返回, 返回的依次是分页器paginator, paginator的Page对象, 请求页的数据page.object_list, 是否有上一页和下一页.</p>
<p>回到get_context_data方法, 更新了context后最后返回了super().get_context_data方法, 根据MRO是ContextMixin中的get_context_data方法, 代码如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'view'</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
</td></tr></table>
<p>可以看到该方法在上下文中添加了ListView实例对象还有实例的extra_context, 因此如果要添加新的上下文除了重写get_context_data方法外, 还可以在实例中定义extra_context属性.</p>
<h3 id="34-render_to_response">3.4 render_to_response渲染到前端</h3>
<p>回到get方法, 最后返回了render_to_response, render_to_response代码如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return a response, using the `response_class` for this view, with a</span>
<span class="sd">    template rendered with the given context.</span>
<span class="sd">    Pass response_kwargs to the constructor of the response class.</span>
<span class="sd">    """</span>
    <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">'content_type'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">(),</span>
        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
        <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_engine</span><span class="p">,</span>
        <span class="o">**</span><span class="n">response_kwargs</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table>
<p>该方法创建了一个TemplateResponse对象并返回, 因为默认的response_class属性是django的TemplateResponse类, 这里需要说明的<code>get_template_names()</code>方法, 按照MRO在MultipleObjectTemplateResponseMixin类中找到:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return a list of template names to be used for the request. Must return</span>
<span class="sd">    a list. May not be called if render_to_response is overridden.</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">ImproperlyConfigured</span><span class="p">:</span>
        <span class="c1"># If template_name isn't specified, it's not a problem --</span>
        <span class="c1"># we just start with an empty list.</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># If the list is a queryset, we'll invent a template name based on the</span>
    <span class="c1"># app and model name. This name gets put at the end of the template</span>
    <span class="c1"># name list so that user-supplied names override the automatically-</span>
    <span class="c1"># generated ones.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_list</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">):</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s%s</span><span class="s2">.html"</span> <span class="o">%</span> <span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name_suffix</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
            <span class="s2">"</span><span class="si">%(cls)s</span><span class="s2"> requires either a 'template_name' attribute "</span>
            <span class="s2">"or a get_queryset() method that returns a QuerySet."</span> <span class="o">%</span> <span class="p">{</span>
                <span class="s1">'cls'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>
</pre></div>
</td></tr></table>
<p>该方法先调用父类的get_template_names()方法, 在TemplateResponseMixin中可以找到:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return a list of template names to be used for the request. Must return</span>
<span class="sd">    a list. May not be called if render_to_response() is overridden.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
            <span class="s2">"TemplateResponseMixin requires either a definition of "</span>
            <span class="s2">"'template_name' or an implementation of 'get_template_names()'"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">]</span>
</pre></div>
</td></tr></table>
<p>可以看出TemplateResponseMixin中的get_template_names方法返回的是template_name属性或者抛出异常, 回到MultipleObjectTemplateResponseMixin中, 可以看出names这个列表添加了个路径, 默认的template_name_suffix属性是<code>_list</code>, 所以默认的路径是<code>你的app/model名_list.html</code>, 所以就算template_name不写也是可以渲染的, 只要路径正确. TemplateResponse接收的template为列表时, 将会一个个试着列表中的路径, 直到成功, 所以写了template_name将会先渲染template_name的路径, 失败后才渲染默认路径.</p>


            <div>
</div>

            
            
            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="/blog/2019_09_10/connet_to_remote_mysql.html" title="Previous: 本地连接到远程服务器上的MySql数据库">本地连接到远程服务器上的MySql数据库</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2019-09-23T00:00:00+08:00">9月 23, 2019</time>

<h4>Last Updated</h4>
<time datetime="2019-09-23T00:00:00+08:00">9月 23, 2019</time>

            <h4>Category</h4>
            <a class="category-link" href="/categories.html#django-ref">Django</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags#yuan-ma-jie-du-ref">源码解读
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="#" title="My You can add links in your config file Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-you can add links in your config file sidebar-social-links"></i></a>
    <a href="#" title="My Another social link Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-another social link sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>



    <div id="fpowered">
        <!--
        Powered by: <a href="https://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow">Elegant</a>
        -->
    </div>
</footer>            <!--<script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script> -->
        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>